# 深入理解存储：SQLite 与结果溯源

本章介绍 hld 的存储层设计、数据落盘策略与调试方法。

## 1. 位置与职责
- 关键文件：`hld/store/sqlite.go`
- 职责：
  - 会话、事件、审批等实体的持久化
  - 读写事务与错误处理

## 2. 数据模型（概念）
- Sessions：会话基本信息（状态、模型、工作目录、时间戳）
- Events：流式事件记录（原始 payload，便于审计与调试）
- Approvals：待审批项与记录（决策、操作者、时间）
- MCPServers 等：会话上下文的运行配置

## 3. 写入策略
- 事件优先持久化，再驱动状态推进与通知
- 写入成功后广播（SSE），保证可追溯

## 4. 迁移与演进
- 新增字段/表时：
  - 设计迁移脚本与回滚策略
  - 覆盖历史数据的默认值与兼容解析

## 5. 调试方法
- 打印 SQL 或关键写入点日志
- 复现用例后直接检查 SQLite（临时用 SQLite 浏览器/CLI）
- 对比 mapper 输出与 DB 实际记录

## 6. 性能注意
- 合理的索引与查询范围控制
- 大量事件的批量写入与分页查询
- 清理策略：归档旧会话与事件，防止库膨胀
